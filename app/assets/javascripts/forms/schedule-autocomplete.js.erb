$(document).ready(function(){

  /* Extend the autocomplete prototype to return class titles as well as codes */
  var proto = $.ui.autocomplete.prototype, initSource = proto._initSource;
/* Override the display form for the autocomplete, so we can make it all sexy and stuff */ var render_item = function(ul, item) {
    var input_text = $(autocomplete_div).val(); 
    var bold_text = $("<strong></strong");
    var index = item.label.indexOf(input_text.toUpperCase());
    var course_label;
    if( index >= 0 ){
      var rest_of_text = item.label.substr( index + input_text.length, item.label.length - input_text.length );
      if( input_text.length > 0 && is_lower_case(input_text[input_text.length-1]))
        rest_of_text = rest_of_text.toLowerCase();
      bold_text = bold_text.append(rest_of_text);
      course_label = $("<div class='course-label'></span>")
                     .append( input_text )
                     .append( bold_text );
    } 
    else {
      course_label = $("<div class='course-label'></span>").append(item.label);
    }
    var course_title = $("<div class='course-title'></span>")["html"](item.title);
    return $("<li></li>")
           .data( "item.autocomplete", item )
           .append($("<a></a>").append( course_label ).append( course_title ))
           .appendTo(ul);
  };

  $.extend( proto, 
    { 
      _renderItem: render_item,
      ///close: function(event) { console.log("CLOSE");}
    });
  

  var class_counter = 0;
  var spacebar_keycode = "32";
  var selected_classes = {};
  var autocomplete_div = "#autocomplete-list";
  var ajax_search_url = "courses/search/auto/subject/";
  var current_mode = "subject";
  var has_classes = false;

  autocomplete_state = "closed";

  /* So there are two main modes for the autocomplete form, subject and course mode
   * 
   *  1. Subject Mode (default): - form searches subjects rather than classes
   *                             - autocomplete select doesn't inject into the list
   *                             - switches to course mode on selection
   *
   *      Triggers:   input field is empty 
   *                  no spaces exist in input
   *
   *  2. Course Mode:  form searches for classes after a subject has been found
   *                   autocomplete select does inject into the list
   *
   *      Triggers:   subject is selected
   *                  a space exists in the input
   *
   *
   *  Approach: 
   */

  function switch_to_subject_mode() {
    $(autocomplete_div).autocomplete( "option", "select", subject_select ); 
    $(autocomplete_div).autocomplete( "option", "source",  ajax_search_url ); 
    current_mode = "subject";
  }

  function switch_to_course_mode(subject_id) {
    $(autocomplete_div).autocomplete( "option", "select", add_course_to_list ); 
    $(autocomplete_div).autocomplete( "option", "source",  ajax_search_url + subject_id.toUpperCase()); 
    current_mode = "course";
  }

  function show_button() {
    if( has_classes ) return;
    $("#user-list .btn").removeClass("hidden");
    $("#user-list .hint").hide("slow");
  };

  /* In order to send a list of class ids to rails, we need to silently 
     keep track of the class ids in a hidden form as well as send the size of the list */
  var add_course_id_to_hidden_form = function( course_id ) { 

    $("<input>").val(course_id)
                .attr("type", "hidden")
                .attr("name", class_counter)
                .appendTo("#hidden-course-form");

  };

  var add_course_to_list = function( event, ui ) {
    var keycode = $.ui.keyCode;
    if( event.keyCode == keycode.TAB ) {
      /* If the user hit a tab, we don't want to add it just yet */
      return;
    }
    /* Prevent input box being filled */ 
    event.preventDefault();
    $(autocomplete_div).val(""); 

    if ( ui.item ) {
      show_button();
      var class_id = ui.item.value;
      if( class_id in selected_classes ){
        /* return if the user as already selected the class*/
        pop_alert("error","class is already selected");
        return;
      } else {
        selected_classes[class_id] = class_counter;
      }

      /* Append the course to the currently populated list */
      var remove_course = $("<a/>").text("X").attr("href", "#").addClass("remove-link");
      var course_li = $("<li/>").append(remove_course).append($("<span/>").text(ui.item.label)).appendTo("#user-course-list ul");
      remove_course.click( function() {
        var removed = 0;
        $("#hidden-course-form").children().each( function(i) {
          if($(this).val() == class_id){
            $(this).remove();
            removed++;
          } else if ($(this).attr("name") == "size"){
            var current_size = $(this).val();
            $(this).val(current_size - removed );
          };
        });
        course_li.remove();
        $(this).remove();
      });

      /* Add the course id to our hidden form */
      add_course_id_to_hidden_form(class_id);
      class_counter++;

      /* use a form to keep track of count */
      $("<input>").val(class_counter)
                  .attr("type", "hidden")
                  .attr("name", "size")
                  .appendTo("#hidden-course-form");
    }

    switch_to_subject_mode();
  };

  var subject_id = undefined;
  function subject_select(event, ui) {
    /* Prevent input box being filled */ 
    // event.preventDefault();
    if ( ui.item ) {
      subject_id = ui.item.value;
      /* Make autocomplete query for classes now */

      switch_to_course_mode(subject_id);
      /* Trigger the autocomplete */
      $(autocomplete_div).autocomplete("search");
    }
  };

  function form_has_characters() {
    var form_value = $(autocomplete_div).val();
    for(var i = 0; i < form_value.length; i++){

      /* If character is a letter or a number */
      if(   (form_value[i] >= "A" && form_value[i] <= "Z")
         || (form_value[i] >= "0" && form_value[i] <= "9")) {
         return true;
      }
    }
    /* No letters or numbers found */
    return false;
  };

  $(autocomplete_div).keyup(function(event) {

    /* A keyup event signifies that the user has changed the input, thus do checks */
    watch_for_empty_form();
    watch_for_single_subject();
    form_suggestion();

    var keycode = $.ui.keyCode;
    var form_value = $(autocomplete_div).val();

    if(event.keyCode == keycode.SPACE) {
      /* Switch to course mode when a user types a space on a non empty form */
      switch_to_course_mode(form_value.split(" ")[0]);
      /* Trigger the autocomplete */
      $(autocomplete_div).autocomplete("search");
    }
    else if (event.keyCode == keycode.DOWN || event.keyCode == keycode.UP) {
      /* This means the user has used the arrows to select an item, thus clear the suggestion */
      $("#autocomplete-suggestion").text("");
    }
  });

  $(autocomplete_div).keydown(function(event) {
    var keycode = $.ui.keyCode;
    if( event.keyCode == keycode.TAB ) {
      var best_result = $(".ui-autocomplete .ui-menu-item .course-label").first().text();
      $(autocomplete_div).val(best_result);
      if( best_result != "" ) event.preventDefault();
    };
  });

  function list_closed() {
    $("#autocomplete-suggestion").text("");
    autocomplete_state = "closed";
  };

  function list_opened() {
    autocomplete_state = "open";
    form_suggestion();
  };

  /* THis is to fix lowercase being inserted into the input form */
  function input_focus(event, ui) {
    var input_text = $(autocomplete_div).val(); 
    if(ui.item) {
      var replacement_string = ui.item.label; 
      if( input_text.length > 0 && is_lower_case(input_text[input_text.length-1]))
        replacement_string = replacement_string.toLowerCase();
      $("#autocomplete-list").val(replacement_string);
      event.preventDefault();
    }
  };

  $(autocomplete_div).autocomplete({ 
    source: ajax_search_url,
    minLength: 1,
    delay: 0,
    autoFocus: true,
    //focus: input_focus,
    select: subject_select,
    close: list_closed,
    open: list_opened,
  });

  function watch_for_single_subject() {

    var results_array = $(".ui-autocomplete .ui-menu-item .course-label");
    if( results_array.length <= 0 ) return;
    var best_result = $(".ui-autocomplete .ui-menu-item .course-label").first().text();

    if( current_mode == "subject" && results_array.length == 1 ) {
      switch_to_course_mode(best_result);
      $(autocomplete_div).autocomplete("search");
    }
  };

  function watch_for_empty_form() {
    if(!form_has_characters()) switch_to_subject_mode();
  };

  function is_lower_case(c) {
    if( c >= 'a' && c <= 'z' )
      return true;
    else
      return false;
  }

  function form_suggestion() {
    /* Get the first result from the list and set it to the background of the input form */
    var best_result = $(".ui-autocomplete .ui-menu-item .course-label").first().text();
    var list = $(".ui-autocomplete").children();
    var suggested_text = "";
    var append_string = "";

    if( autocomplete_state == "open" && list.length != 0 ) {
      current = $("#autocomplete-list").val();
      append_string = best_result.substring(current.length);
      if( is_lower_case(current[current.length-1]))
        append_string = append_string.toLowerCase();
      suggested_text = current + append_string;
      $("#autocomplete-suggestion").text(suggested_text);
    }
  };

});

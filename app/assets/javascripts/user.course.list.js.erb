var class_counter = 0;
var has_classes = false;
var selected_classes = {};
var course_destroy_url  = '/user/courses/destroy/';
var min_hours = 0;
var max_hours = 0;

function ClassList(){ }

ClassList.prototype.init = function() {
    min_hours = parseInt($(".hour-count").attr("data-hours-min"));
    max_hours = parseInt($(".hour-count").attr("data-hours-max"));
    $(".user-course-list ul li ").each( function() { 
        has_classes = true;
        var class_id = $(this).find(".id").text(); 
        var class_min_hours = $(this).attr("data-hours-min");
        var class_max_hours = $(this).attr("data-hours-max");
        //console.log( class_min_hours + "-" + class_max_hours );
        //min_hours += class_min_hours;
        //max_hours += class_max_hours;

        selected_classes[class_id] = $(this);

        var class_li = $(this);
        $(this).find(".remove-link").click( function() {
          mpq.track("Class removed");
					$.ajax({
								type: 'GET',
                url: course_destroy_url + class_id,
                success: function() {
                  max_hours -= class_max_hours;
                  min_hours -= class_min_hours;
                  update_hours();
                  //console.log( class_max_hours + "-" + class_min_hours );
                  delete selected_classes[ class_id ];
                  class_li.slideUp(function(){ $(this).remove() });
                }
					});
        });
    });
}

ClassList.prototype.add_class_callback = function(event, ui) {
    var keycode = $.ui.keyCode;
    if( event.keyCode == keycode.TAB ) {
        /* If the user hit a tab, we don't want to add it just yet */
        return;
    }
    /* Prevent input box being filled */ 
    event.preventDefault();
    this.value = ""; 

    if ( ui.item ) {
        mpq.track("Class added");
        var class_id = ui.item.id;
        if( class_id in selected_classes ){
            /* return if the user as already selected the class*/
            pop_alert("error", ui.item.value, " is already selected");
            selected_classes[class_id].animate({
                backgroundColor: '#F08080',
            }, 100, function() {
                $(this).animate({backgroundColor: 'white'}, 500, undefined);
            });
            return;
        }

        /* Append the course to the currently populated list */
        var remove_course = $("<a/>").text("X").addClass("remove-link");
        max_hours += parseInt(ui.item.max_hours);
        min_hours += parseInt(ui.item.min_hours);
        show_button();
        update_hours();
        var hour_string;
        if( ui.item.max_hours - ui.item.min_hours != 0 )
          hour_string = ui.item.min_hours + "-" + ui.item.max_hours + " hr";
        else
          hour_string = ui.item.min_hours + " hr";
        var course_li = $("<li/>")
                            .append(remove_course)
                            .append($("<span/>")
                                .text(ui.item.label)
                                .addClass("code"))
                            .append($("<span/>")
                                .text(ui.item.title)
                                .addClass("title"))
                            .append($("<span/>")
                                .text(hour_string)
                                .addClass("hours"))
                            .append($("<span/>")
                                .text(ui.item.id)
                                .addClass("hidden id"))
                            .css("display", "none");
        course_li.appendTo(".user-course-list ul");
        course_li.slideDown();

        remove_course.click( function() {
          mpq.track("Class removed");
          var removed = 0;
          $.ajax({
              type: 'GET',
              url:  '/user/courses/destroy/'+ui.item.id,
            });
          course_li.slideUp();
          $(this).remove();
          max_hours -= parseInt( ui.item.max_hours );
          min_hours -= parseInt( ui.item.min_hours );
          update_hours();
          delete selected_classes[class_id];
        });

        selected_classes[class_id] = course_li;

					/* Call add courses */
			var string_class_id = class_id.toString();		    
			$.ajax({
		      type: 'POST',
		      data: { id: class_id },
          dataType: 'json',
		      url:  '/user/courses/new',
          success: function( data, textStatus, xh ) {
            if( data.status == "success" ) {
              var course = get_course_li( class_id );
              //add_users_to_course( course, eval( data.users ));
            } else {
              pop_alert( data.status, data.message );
            }
          }
		    });
    }
}

/* Adds a json set of users to a certain course list element */
function add_users_to_course( course, users ) {
  var current_user_id = parseInt( $("#current_user").text() );
  for( var i = 0; i < users.length; i++ ) {
    if( users[i].id == current_user_id ) {
      //console.log( "user is the same wtf!" );
    }
  }
  // Get current user
}

function get_course_li( course_id ) {
  var course_list = $(".user-course-list ul li");
  //console.log( course_list );
  var current_course;
  for( var i =0; i < course_list.length; i++ ) {
    current_course = $(course_list[i]);
    //console.log( current_course );
    if( current_course.find(".id").text() == course_id.toString() ) {
      return current_course;
    }
    //console.log( current_course.find(".id").text() + "-" + course_id );
  }
}

ClassList.prototype.has_classes = function() {
  return has_classes;
}

function update_hours() {
  if( min_hours - max_hours != 0 )
    var hour_string = "Total " + min_hours + "-" + max_hours + " hrs";
  else
    var hour_string = "Total " + max_hours + " hrs";
  $(".hour-count").text( hour_string );
}

function show_button() {
    if( has_classes ) return;

    $(".user-course-list span.hint").slideUp();
    $(".user-course-list h1").hide(true);
    update_hours();
    setTimeout( function() {$(".hour-count").slideDown();}, 500);
    var course_list = $(".user-course-list");
    var header = $("<h1/>").text("<%= $CURRENT_SEMESTER.name %>").addClass("hidden");
    course_list.prepend(header);
    header.slideDown();

    has_classes = true;
};

/* In order to send a list of class ids to rails, we need to silently 
   keep track of the class ids in a hidden form as well as send the size of the list */
var add_course_id_to_hidden_form = function( course_id ) { 
    $("<input>").val(course_id)
        .attr("type", "hidden")
        .attr("name", class_counter)
        .appendTo(".hidden-course-form");
};
